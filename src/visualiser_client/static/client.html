<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jointjs/3.6.2/joint.css" />
</head>
<body>
    <!-- content -->
    <div id="myholder"></div>

    <!-- dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.4.1/backbone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jointjs/3.6.5/joint.js"></script>

    <!-- code -->
    <script type="text/javascript">
        let namespace = joint.shapes;

        let graph;

        let paper;

        let visualizer_config;

        function setup(visualizer_config) {
            console.log("Visualizer is being setup");
            graph = new joint.dia.Graph({}, { cellNamespace: namespace });

            paper = new joint.dia.Paper({
                el: document.getElementById('myholder'),
                model: graph,
                width: visualizer_config.window_width,
                height: visualizer_config.window_height,
                gridSize: visualizer_config.grid_size,
                drawGrid: visualizer_config.draw_grid,
                background: {
                    color: visualizer_config.background_color
                },
                cellViewNamespace: namespace
            });
        }

        fetch("visualizer_config.json")
            .then(response => response.json())
            .then(data => {
                //visualizer_config = JSON.parse(JSON.stringify(data));
                visualizer_config = data
                console.log(visualizer_config.background_color);

                setup(visualizer_config)

                fetch("graph.json")
                    .then(response => response.json())
                    .then(data => {
                        // const r1 = new joint.shapes.standard.Rectangle({
                        //     layer: "group1",
                        //     position: { x: 200, y: 200 },
                        //     size: { width: 80, height: 300 },
                        //     attrs: {
                        //         root: {
                        //         magnet: false
                        //         },
                        //         body: {
                        //         stroke: "#333333",
                        //         fill: "#fff",
                        //         rx: 5,
                        //         ry: 5
                        //         }
                        //     },
                        //     portMarkup: [
                        //         {
                        //         tagName: "circle",
                        //         selector: "portBody",
                        //         attributes: {
                        //             r: 3,
                        //             fill: "#FFFFFF",
                        //             stroke: "#333333"
                        //         }
                        //         }
                        //     ],
                        //     portLabelMarkup: [
                        //         {
                        //         tagName: "rect",
                        //         selector: "portLabelBackground"
                        //         },
                        //         {
                        //         tagName: "text",
                        //         selector: "portLabel",
                        //         attributes: {
                        //             fill: "#333333"
                        //         }
                        //         }
                        //     ],
                        //     ports: {
                        //         groups: {
                        //         left: {
                        //             position: "left",
                        //             label: {
                        //             position: {
                        //                 name: "outside",
                        //                 args: {
                        //                 offset: 10
                        //                 }
                        //             }
                        //             },
                        //             attrs: {
                        //             // portLabelBackground: {
                        //             //     ref: "portLabel",
                        //             //     fill: "#FFFFFF",
                        //             //     fillOpacity: 0.8,
                        //             //     x: "calc(x - calc(w + 4))",
                        //             //     y: "calc(y - 2)",
                        //             //     width: "calc(w + 4)",
                        //             //     height: "calc(h + 4)"
                        //             // },
                        //             portLabel: {
                        //                 fontFamily: "sans-serif",
                        //                 fontSize: 8
                        //             },
                        //             portBody: {
                        //                 strokeWidth: 2,
                        //                 magnet: "active"
                        //             }
                        //             }
                        //         },
                        //         right: {
                        //             position: "right",
                        //             label: {
                        //             position: {
                        //                 name: "outside",
                        //                 args: {
                        //                 offset: 25
                        //                 }
                        //             }
                        //             },
                        //             attrs: {
                        //             portLabelBackground: {
                        //                 ref: "portLabel",
                        //                 fill: "#FFFFFF",
                        //                 fillOpacity: 0.8,
                        //                 x: "calc(x - 2)",
                        //                 y: "calc(y - 2)",
                        //                 width: "calc(w + 4)",
                        //                 height: "calc(h + 4)"
                        //             },
                        //             portLabel: {
                        //                 fontFamily: "sans-serif"
                        //             },
                        //             portBody: {
                        //                 strokeWidth: 2,
                        //                 magnet: "active"
                        //             }
                        //             }
                        //         }
                        //         },
                        //         items: [
                        //         {
                        //             id: "p1",
                        //             group: "left",
                        //             attrs: {
                        //             portLabel: {
                        //                 text: "Port 1"
                        //             }
                        //             }
                        //         },
                        //         {
                        //             id: "p2",
                        //             group: "left",
                        //             attrs: {
                        //             portLabel: {
                        //                 text: "Port 2"
                        //             }
                        //             }
                        //         },
                        //         {
                        //             id: "out1",
                        //             group: "right",
                        //             attrs: {
                        //             portLabel: {
                        //                 text: "Out 1"
                        //             }
                        //             }
                        //         },
                        //         {
                        //             id: "out2",
                        //             group: "right",
                        //             attrs: {
                        //             portLabel: {
                        //                 text: "Out 2"
                        //             }
                        //             }
                        //         },
                        //         {
                        //             id: "out3",
                        //             group: "right",
                        //             attrs: {
                        //             portLabel: {
                        //                 text: "Out 2"
                        //             }
                        //             }
                        //         }
                        //         ]
                        //     }
                        //     });
                        // r1.addTo(graph);
                        // var rect = new joint.shapes.standard.Rectangle();
                        // rect.position(100, 30);
                        // rect.resize(100, 40);
                        // rect.attr({
                        //     body: {
                        //         fill: 'blue'
                        //     },
                        //     label: {
                        //         text: 'Hello',
                        //         fill: 'white'
                        //     }
                        // });
                        // rect.addTo(graph);
                        // var rect2 = new joint.shapes.standard.Rectangle();
                        // rect2.position(400, 30);
                        // rect2.resize(100, 40);
                        // rect2.attr({
                        //     body: {
                        //         fill: '#2C3E50',
                        //         rx: 5,
                        //         ry: 5,
                        //         strokeWidth: 2
                        //     },
                        //     label: {
                        //         text: 'World!',
                        //         fill: '#3498DB',
                        //         fontSize: 18,
                        //         fontWeight: 'bold',
                        //         fontVariant: 'small-caps'
                        //     }
                        // });
                        // rect2.addTo(graph);

                        // var link2 = new joint.shapes.standard.Link();
                        // link2.source(rect);
                        // link2.target(rect2);
                        // // link2.vertices([
                        // //     new g.Point(250, 100),
                        // //     new g.Point(300, 150),
                        // //     new g.Point(350, 200)
                        // // ]);
                        // link2.router('orthogonal');
                        // //link2.connector('rounded');
                        // link2.attr({
                        //     line: {
                        //         stroke: 'gray',
                        //         strokeWidth: 2,
                        //         //strokeDasharray: '4 2',
                        //         // sourceMarker: {
                        //         //     'type': 'image',
                        //         //     'xlink:href': 'https://cdn3.iconfinder.com/data/icons/49handdrawing/24x24/left.png',
                        //         //     'width': 24,
                        //         //     'height': 24,
                        //         //     'y': -12
                        //         // },
                        //         // targetMarker: {
                        //         //     'type': 'image',
                        //         //     'xlink:href': 'https://cdn3.iconfinder.com/data/icons/49handdrawing/24x24/left.png',
                        //         //     'width': 24,
                        //         //     'height': 24,
                        //         //     'y': -12
                        //         // }
                        //     }
                        // });
                        // link2.addTo(graph);

                        
                        graph.fromJSON(data);
                        console.log("graph is setup");
                        paper.on('cell:pointerup', function(evt, x, y) {
                            const requestOptions = {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(graph.toJSON()) // << data going the other way
                            };
                            fetch('/api/graph', requestOptions);
                        });
                    });
            });


        

    </script>
</body>
</html>
